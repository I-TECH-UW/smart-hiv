<?xml version="1.0" encoding="UTF-8"?>

<Library xmlns="http://hl7.org/fhir">
  <id value="HIVB2DTLogic"/>
  <meta>
    <profile value="http://hl7.org/fhir/uv/crmi/StructureDefinition/crmi-shareablelibrary"/>
    <profile value="http://hl7.org/fhir/uv/crmi/StructureDefinition/crmi-publishablelibrary"/>
    <profile value="http://hl7.org/fhir/uv/cql/StructureDefinition/cql-library"/>
    <profile value="http://hl7.org/fhir/uv/cql/StructureDefinition/cql-module"/>
  </meta>
  <text>
    <status value="generated"/><div xmlns="http://www.w3.org/1999/xhtml"><p class="res-header-id"><b>Generated Narrative: Library HIVB2DTLogic</b></p><a name="HIVB2DTLogic"> </a><a name="hcHIVB2DTLogic"> </a><a name="HIVB2DTLogic-en-US"> </a><h2>Contents</h2><p><code>text/cql</code></p><pre><code class="language-sql">/**
Library: HIV.B2.DT Logic

@DecisionID: HIV.B2.DT
@BusinessRule: Check for signs of serious illness
@Trigger: HIV.B2 Check for signs of serious illness
@Trigger: HIV.D3 Check for signs of serious illness
@HitPolicy: Rule Order
@Description: Check for serious illness

Data Concepts:
 * HIV.A.DE17: Age | Calculated age (number of years) of the client based on date of birth
 * HIV.D.DE17: Signs of serious illness | Signs that may indicate the client has a serious illness and needs triage or an emergency referral
 * HIV.D.DE9: Body temperature | Temperature of the client in Celsius

Consolidated guidelines on HIV prevention, testing, treatment, service delivery and monitoring: recommendations for a public health approach (2021) Chapter 5: Advanced HIV Disease. Figure 5.1: Algorithm for providing a package of care for people with advanced HIV disease.
*/

library HIVB2DTLogic

using FHIR version '4.0.1'

include HIVCommon version '0.0.1' called HIC
include HIVConcepts called HCx
include HIVEncounterElements called Elements
include FHIRHelpers version '4.0.1'

include WHOCommon called WCom

context Patient

 /*
  @input: &quot;Age 10 or older&quot;
  @pseudocode: 'Age' &gt;= 10 years
  */
define &quot;Age 10 or older&quot;:
  AgeInYearsAt(Today()) &gt;= 10

 /*
  @input: &quot;Age under 10&quot;
  @pseudocode: 'Age' &lt; 10 years
  */
define &quot;Age under 10&quot;:
  AgeInYearsAt(Today()) &lt; 10

/*
 @output: &quot;Immediately take action or refer for care if a client is having this issue&quot;
 */
define &quot;Immediately take action or refer for care if a client is having this issue&quot;:
  exists(Elements.&quot;Signs of serious illness&quot; O
    where &quot;Age 10 or older&quot; 
      and O.value ~ HCx.&quot;Tachycardia&quot;)

/*
 @output &quot;Immediately take action or refer for care if client is showing this sign of a serious illness.&quot;
 */
define &quot;Immediately take action or refer for care if client is showing this sign of a serious illness&quot;:
  &quot;Signs of serious illness age 10 or older&quot; or &quot;Signs of serious illness age under 10&quot;

/*
 @output &quot;Use clinical judgement and consider local epidemiology to determine if symptoms suggest client is seriously ill&quot;
 */
define &quot;Use clinical judgement and consider local epidemiology to determine if symptoms suggest client is seriously ill&quot;:
  &quot;Signs of serious illness requiring clinical judgement age 10 or older&quot; or &quot;Signs of serious illness requiring clinical judgement age under 10&quot;

/*
 @dynamicValue: Guidance
 */
define &quot;Guidance&quot;:
  case 
  when &quot;Immediately take action or refer for care if a client is having this issue&quot; 
    then &quot;Immediately take action or refer for care if a client is having this issue.&quot;
  when &quot;Immediately take action or refer for care if client is showing this sign of a serious illness&quot; and &quot;Age 10 or older&quot;
    then &quot;Immediately take action or refer for care if client is showing this sign of a serious illness.&quot;
  when &quot;Immediately take action or refer for care if client is showing this sign of a serious illness&quot; and &quot;Age under 10&quot;
    then &quot;&quot;&quot;This is a sign and/or symptom of a serious health condition.
  
Immediately take action or refer for care if client is showing this sign of a serious illness.&quot;&quot;&quot;
  else null
  end

/*
 Supporting Logic
*/
define &quot;Signs of serious illness age 10 or older&quot;:
  &quot;Age 10 or older&quot; and Elements.&quot;Signs of serious illness&quot; O
    where
      O.value ~ HCx.&quot;Tachypnea&quot; or
      O.value ~ HCx.&quot;Unable to walk unaided&quot;

define &quot;Signs of serious illness age under 10&quot;:
  &quot;Age under 10&quot; and Elements.&quot;Signs of serious illness&quot; O
    where 
      O.value in {
        HCx.&quot;Lethargy - HIV.D.DE22&quot;,
        HCx.&quot;Unconsciousness&quot;,
        HCx.&quot;Convulsions&quot;,
        HCx.&quot;Unable to breastfeed&quot;,
        HCx.&quot;Unable to drink&quot;,
        HCx.&quot;Repeated vomiting&quot;
      } 
  
define &quot;Signs of serious illness requiring clinical judgement age 10 or older&quot;:
  &quot;Age 10 or older&quot; and Elements.&quot;Signs of serious illness&quot; O
    where
      O.value ~ HCx.&quot;Fever of 39 C or greater&quot; or
      O.value ~ HCx.&quot;Other sign of serious illness&quot;
  
define &quot;Signs of serious illness requiring clinical judgement age under 10&quot;:
  &quot;Age under 10&quot; and Elements.&quot;Signs of serious illness&quot; O
    where 
      O.value ~ HCx.&quot;Fever of 39 C or greater&quot; or
      O.value ~ HCx.&quot;Other sign of serious illness&quot;
</code></pre><p><code>No Content</code> (<code>application/elm+xml</code>)</p></div>
  </text>
  <extension url="http://hl7.org/fhir/StructureDefinition/cqf-knowledgeCapability">
    <valueCode value="computable"/>
  </extension>
  <url value="http://smart.who.int/hiv/Library/HIVB2DTLogic"/>
  <version value="0.2.0"/>
  <name value="HIVB2DTLogic"/>
  <title value="HIV.B2.DT Logic"/>
  <status value="draft"/>
  <experimental value="true"/>
  <type>
    <coding>
      <system value="http://terminology.hl7.org/CodeSystem/library-type"/>
      <code value="logic-library"/>
    </coding>
  </type>
  <date value="2024-08-13T19:21:15+00:00"/>
  <publisher value="WHO"/>
  <contact>
    <name value="WHO"/>
    <telecom>
      <system value="url"/>
      <value value="http://who.int"/>
    </telecom>
  </contact>
  <description value="Description not yet available for HIV.B2.DT Logic."/>
  <content>
    <contentType value="text/cql"/>
    <data value="LyoqCkxpYnJhcnk6IEhJVi5CMi5EVCBMb2dpYwoKQERlY2lzaW9uSUQ6IEhJVi5CMi5EVApAQnVzaW5lc3NSdWxlOiBDaGVjayBmb3Igc2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzCkBUcmlnZ2VyOiBISVYuQjIgQ2hlY2sgZm9yIHNpZ25zIG9mIHNlcmlvdXMgaWxsbmVzcwpAVHJpZ2dlcjogSElWLkQzIENoZWNrIGZvciBzaWducyBvZiBzZXJpb3VzIGlsbG5lc3MKQEhpdFBvbGljeTogUnVsZSBPcmRlcgpARGVzY3JpcHRpb246IENoZWNrIGZvciBzZXJpb3VzIGlsbG5lc3MKCkRhdGEgQ29uY2VwdHM6CiAqIEhJVi5BLkRFMTc6IEFnZSB8IENhbGN1bGF0ZWQgYWdlIChudW1iZXIgb2YgeWVhcnMpIG9mIHRoZSBjbGllbnQgYmFzZWQgb24gZGF0ZSBvZiBiaXJ0aAogKiBISVYuRC5ERTE3OiBTaWducyBvZiBzZXJpb3VzIGlsbG5lc3MgfCBTaWducyB0aGF0IG1heSBpbmRpY2F0ZSB0aGUgY2xpZW50IGhhcyBhIHNlcmlvdXMgaWxsbmVzcyBhbmQgbmVlZHMgdHJpYWdlIG9yIGFuIGVtZXJnZW5jeSByZWZlcnJhbAogKiBISVYuRC5ERTk6IEJvZHkgdGVtcGVyYXR1cmUgfCBUZW1wZXJhdHVyZSBvZiB0aGUgY2xpZW50IGluIENlbHNpdXMKCkNvbnNvbGlkYXRlZCBndWlkZWxpbmVzIG9uIEhJViBwcmV2ZW50aW9uLCB0ZXN0aW5nLCB0cmVhdG1lbnQsIHNlcnZpY2UgZGVsaXZlcnkgYW5kIG1vbml0b3Jpbmc6IHJlY29tbWVuZGF0aW9ucyBmb3IgYSBwdWJsaWMgaGVhbHRoIGFwcHJvYWNoICgyMDIxKSBDaGFwdGVyIDU6IEFkdmFuY2VkIEhJViBEaXNlYXNlLiBGaWd1cmUgNS4xOiBBbGdvcml0aG0gZm9yIHByb3ZpZGluZyBhIHBhY2thZ2Ugb2YgY2FyZSBmb3IgcGVvcGxlIHdpdGggYWR2YW5jZWQgSElWIGRpc2Vhc2UuCiovCgpsaWJyYXJ5IEhJVkIyRFRMb2dpYwoKdXNpbmcgRkhJUiB2ZXJzaW9uICc0LjAuMScKCmluY2x1ZGUgSElWQ29tbW9uIHZlcnNpb24gJzAuMC4xJyBjYWxsZWQgSElDCmluY2x1ZGUgSElWQ29uY2VwdHMgY2FsbGVkIEhDeAppbmNsdWRlIEhJVkVuY291bnRlckVsZW1lbnRzIGNhbGxlZCBFbGVtZW50cwppbmNsdWRlIEZISVJIZWxwZXJzIHZlcnNpb24gJzQuMC4xJwoKaW5jbHVkZSBXSE9Db21tb24gY2FsbGVkIFdDb20KCmNvbnRleHQgUGF0aWVudAoKIC8qCiAgQGlucHV0OiAiQWdlIDEwIG9yIG9sZGVyIgogIEBwc2V1ZG9jb2RlOiAnQWdlJyA+PSAxMCB5ZWFycwogICovCmRlZmluZSAiQWdlIDEwIG9yIG9sZGVyIjoKICBBZ2VJblllYXJzQXQoVG9kYXkoKSkgPj0gMTAKCiAvKgogIEBpbnB1dDogIkFnZSB1bmRlciAxMCIKICBAcHNldWRvY29kZTogJ0FnZScgPCAxMCB5ZWFycwogICovCmRlZmluZSAiQWdlIHVuZGVyIDEwIjoKICBBZ2VJblllYXJzQXQoVG9kYXkoKSkgPCAxMAoKLyoKIEBvdXRwdXQ6ICJJbW1lZGlhdGVseSB0YWtlIGFjdGlvbiBvciByZWZlciBmb3IgY2FyZSBpZiBhIGNsaWVudCBpcyBoYXZpbmcgdGhpcyBpc3N1ZSIKICovCmRlZmluZSAiSW1tZWRpYXRlbHkgdGFrZSBhY3Rpb24gb3IgcmVmZXIgZm9yIGNhcmUgaWYgYSBjbGllbnQgaXMgaGF2aW5nIHRoaXMgaXNzdWUiOgogIGV4aXN0cyhFbGVtZW50cy4iU2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzIiBPCiAgICB3aGVyZSAiQWdlIDEwIG9yIG9sZGVyIiAKICAgICAgYW5kIE8udmFsdWUgfiBIQ3guIlRhY2h5Y2FyZGlhIikKCi8qCiBAb3V0cHV0ICJJbW1lZGlhdGVseSB0YWtlIGFjdGlvbiBvciByZWZlciBmb3IgY2FyZSBpZiBjbGllbnQgaXMgc2hvd2luZyB0aGlzIHNpZ24gb2YgYSBzZXJpb3VzIGlsbG5lc3MuIgogKi8KZGVmaW5lICJJbW1lZGlhdGVseSB0YWtlIGFjdGlvbiBvciByZWZlciBmb3IgY2FyZSBpZiBjbGllbnQgaXMgc2hvd2luZyB0aGlzIHNpZ24gb2YgYSBzZXJpb3VzIGlsbG5lc3MiOgogICJTaWducyBvZiBzZXJpb3VzIGlsbG5lc3MgYWdlIDEwIG9yIG9sZGVyIiBvciAiU2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzIGFnZSB1bmRlciAxMCIKCi8qCiBAb3V0cHV0ICJVc2UgY2xpbmljYWwganVkZ2VtZW50IGFuZCBjb25zaWRlciBsb2NhbCBlcGlkZW1pb2xvZ3kgdG8gZGV0ZXJtaW5lIGlmIHN5bXB0b21zIHN1Z2dlc3QgY2xpZW50IGlzIHNlcmlvdXNseSBpbGwiCiAqLwpkZWZpbmUgIlVzZSBjbGluaWNhbCBqdWRnZW1lbnQgYW5kIGNvbnNpZGVyIGxvY2FsIGVwaWRlbWlvbG9neSB0byBkZXRlcm1pbmUgaWYgc3ltcHRvbXMgc3VnZ2VzdCBjbGllbnQgaXMgc2VyaW91c2x5IGlsbCI6CiAgIlNpZ25zIG9mIHNlcmlvdXMgaWxsbmVzcyByZXF1aXJpbmcgY2xpbmljYWwganVkZ2VtZW50IGFnZSAxMCBvciBvbGRlciIgb3IgIlNpZ25zIG9mIHNlcmlvdXMgaWxsbmVzcyByZXF1aXJpbmcgY2xpbmljYWwganVkZ2VtZW50IGFnZSB1bmRlciAxMCIKCi8qCiBAZHluYW1pY1ZhbHVlOiBHdWlkYW5jZQogKi8KZGVmaW5lICJHdWlkYW5jZSI6CiAgY2FzZSAKICB3aGVuICJJbW1lZGlhdGVseSB0YWtlIGFjdGlvbiBvciByZWZlciBmb3IgY2FyZSBpZiBhIGNsaWVudCBpcyBoYXZpbmcgdGhpcyBpc3N1ZSIgCiAgICB0aGVuICJJbW1lZGlhdGVseSB0YWtlIGFjdGlvbiBvciByZWZlciBmb3IgY2FyZSBpZiBhIGNsaWVudCBpcyBoYXZpbmcgdGhpcyBpc3N1ZS4iCiAgd2hlbiAiSW1tZWRpYXRlbHkgdGFrZSBhY3Rpb24gb3IgcmVmZXIgZm9yIGNhcmUgaWYgY2xpZW50IGlzIHNob3dpbmcgdGhpcyBzaWduIG9mIGEgc2VyaW91cyBpbGxuZXNzIiBhbmQgIkFnZSAxMCBvciBvbGRlciIKICAgIHRoZW4gIkltbWVkaWF0ZWx5IHRha2UgYWN0aW9uIG9yIHJlZmVyIGZvciBjYXJlIGlmIGNsaWVudCBpcyBzaG93aW5nIHRoaXMgc2lnbiBvZiBhIHNlcmlvdXMgaWxsbmVzcy4iCiAgd2hlbiAiSW1tZWRpYXRlbHkgdGFrZSBhY3Rpb24gb3IgcmVmZXIgZm9yIGNhcmUgaWYgY2xpZW50IGlzIHNob3dpbmcgdGhpcyBzaWduIG9mIGEgc2VyaW91cyBpbGxuZXNzIiBhbmQgIkFnZSB1bmRlciAxMCIKICAgIHRoZW4gIiIiVGhpcyBpcyBhIHNpZ24gYW5kL29yIHN5bXB0b20gb2YgYSBzZXJpb3VzIGhlYWx0aCBjb25kaXRpb24uCiAgCkltbWVkaWF0ZWx5IHRha2UgYWN0aW9uIG9yIHJlZmVyIGZvciBjYXJlIGlmIGNsaWVudCBpcyBzaG93aW5nIHRoaXMgc2lnbiBvZiBhIHNlcmlvdXMgaWxsbmVzcy4iIiIKICBlbHNlIG51bGwKICBlbmQKCi8qCiBTdXBwb3J0aW5nIExvZ2ljCiovCmRlZmluZSAiU2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzIGFnZSAxMCBvciBvbGRlciI6CiAgIkFnZSAxMCBvciBvbGRlciIgYW5kIEVsZW1lbnRzLiJTaWducyBvZiBzZXJpb3VzIGlsbG5lc3MiIE8KICAgIHdoZXJlCiAgICAgIE8udmFsdWUgfiBIQ3guIlRhY2h5cG5lYSIgb3IKICAgICAgTy52YWx1ZSB+IEhDeC4iVW5hYmxlIHRvIHdhbGsgdW5haWRlZCIKCmRlZmluZSAiU2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzIGFnZSB1bmRlciAxMCI6CiAgIkFnZSB1bmRlciAxMCIgYW5kIEVsZW1lbnRzLiJTaWducyBvZiBzZXJpb3VzIGlsbG5lc3MiIE8KICAgIHdoZXJlIAogICAgICBPLnZhbHVlIGluIHsKICAgICAgICBIQ3guIkxldGhhcmd5IC0gSElWLkQuREUyMiIsCiAgICAgICAgSEN4LiJVbmNvbnNjaW91c25lc3MiLAogICAgICAgIEhDeC4iQ29udnVsc2lvbnMiLAogICAgICAgIEhDeC4iVW5hYmxlIHRvIGJyZWFzdGZlZWQiLAogICAgICAgIEhDeC4iVW5hYmxlIHRvIGRyaW5rIiwKICAgICAgICBIQ3guIlJlcGVhdGVkIHZvbWl0aW5nIgogICAgICB9IAogIApkZWZpbmUgIlNpZ25zIG9mIHNlcmlvdXMgaWxsbmVzcyByZXF1aXJpbmcgY2xpbmljYWwganVkZ2VtZW50IGFnZSAxMCBvciBvbGRlciI6CiAgIkFnZSAxMCBvciBvbGRlciIgYW5kIEVsZW1lbnRzLiJTaWducyBvZiBzZXJpb3VzIGlsbG5lc3MiIE8KICAgIHdoZXJlCiAgICAgIE8udmFsdWUgfiBIQ3guIkZldmVyIG9mIDM5IEMgb3IgZ3JlYXRlciIgb3IKICAgICAgTy52YWx1ZSB+IEhDeC4iT3RoZXIgc2lnbiBvZiBzZXJpb3VzIGlsbG5lc3MiCiAgCmRlZmluZSAiU2lnbnMgb2Ygc2VyaW91cyBpbGxuZXNzIHJlcXVpcmluZyBjbGluaWNhbCBqdWRnZW1lbnQgYWdlIHVuZGVyIDEwIjoKICAiQWdlIHVuZGVyIDEwIiBhbmQgRWxlbWVudHMuIlNpZ25zIG9mIHNlcmlvdXMgaWxsbmVzcyIgTwogICAgd2hlcmUgCiAgICAgIE8udmFsdWUgfiBIQ3guIkZldmVyIG9mIDM5IEMgb3IgZ3JlYXRlciIgb3IKICAgICAgTy52YWx1ZSB+IEhDeC4iT3RoZXIgc2lnbiBvZiBzZXJpb3VzIGlsbG5lc3MiCg=="/>
  </content>
  <content>
    <contentType value="application/elm+xml"/>
  </content>
</Library>