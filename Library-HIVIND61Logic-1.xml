<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1">
   <annotation translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" signatureLevel="Overloads" xsi:type="a:CqlToElmInfo"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="63">
         <a:s>/**
 * Library: HIV.IND.61 Logic
 * Ref No: STI.1C2
 * Short Name: Syphilis testing coverage, pregnant women, any ANC visit
 *
 * Definition: % of pregnant women who were tested for syphilis on any ANC visit during the reporting period
 *
 * Numerator: Number of pregnant women tested for syphilis while attending any ANC services
 * Numerator Calculation: COUNT of pregnant women with &quot;ANC contact date&quot; in reporting period AND &quot;Syphilis test date&quot; on ANY &quot;ANC contact date&quot; for this pregnancy
 * Numerator Exclusions: 
 *
 * Denominator: Number of pregnant women attending ANC services
 * Denominator Calculation: COUNT of pregnant women with &quot;ANC contact date&quot; in reporting period
 * Denominator Exclusions: 
 *
 * Disaggregations:
 * • Age (15–19, 20–24, 25–29, 30–49, 50+ years) 
 *  • HIV status (HIV-positive, HIV-negative, unknown status) 
 *  • Cities and other administrative regions of epidemiologic importance
 *
 * Disaggregation Elements: Age | HIV status
 *
 * Numerator and Denominator Elements:
 * ANC contact date 
 *  Syphilis test date
 *
 * Reference: Consolidated guidelines on person-centred HIV strategic information: strengthening routine data for impact. Geneva: World Health Organization; 2022
 * 
 * Data Concepts:
 * HIV.A.DE17: Age | Calculated age (number of years) of the client based on date of birth
 * HIV.B.DE115: HIV status | HIV status reported after applying the national HIV testing algorithm. No single HIV test can provide an HIV-positive diagnosis.
 * HIV.B.DE116: HIV-positive | Client is HIV-positive
 * HIV.B.DE117: HIV-negative | Client is HIV-negative
 * HIV.B.DE118: Unknown | Client has unknown HIV status
 * HIV.B.DE249: Syphilis test date | Date of syphilis test
 * HIV.D.DE801: Syphilis test date | Date of syphilis test
 * HIV.E.DE85: ANC contact date | The date and time of the client's ANC contact (in the ANC DAK this is called 'Contact date')
 * HIV.G.DE69: Syphilis test date | Date of syphilis test
 * HIV.SRV.DE18: ANC contact date | The date and time of the client's ANC contact (in the ANC DAK this is called 'Contact date')
 *
 * Additional Context
 * - what it measures: A: % of people attending HIV prevention services who were tested for syphilis during the reporting period | B: % of people living with HIV who were tested for syphilis during the reporting period  | C: % of pregnant women who were tested for syphilis during the reporting period
 * - rationale: • Measuring the burden of syphilis among people living with HIV and among populations at elevated risk of HIV acquisition can help national planners determine the resources needed to address both diseases. | • Testing pregnant women for syphilis is important for their own health, and it is also the first step in the prevention of vertical transmission of syphilis. Knowing the testing coverage contributes to quality assessment across the full scope of antenatal care services. | • Testing for syphilis identifies individuals who would benefit from treatment. | • Testing coverage measures progress towards scaling up screening/testing and can be used to assess whether national screening guidelines are being followed.
 * - method: Individual-level data obtained from programme records |  | If individual-level data are not available, the indicator can be reported using aggregate programme data. If aggregate data are used and it is not possible to exclude individuals who are tested more than once during the reporting period, the testing coverage estimates will be inflated. |  | Testing (screening) may be done using either a nontreponemal test (for example, venereal disease research laboratory [VDRL] or rapid plasma reagin [RPR]) or a treponemal test | (for example, Treponema pallidum haemagglutination assay [TPHA], Treponema pallidum particle agglutination assay [TPPA], enzyme immunoassay or rapid treponemal test). For this indicator, having either type of test (treponemal or nontreponemal) is sufficient, although being tested with both is preferred.
 * 
 * Suggested Scoring Method: proportion | http://hl7.org/fhir/us/cqfmeasures/StructureDefinition/proportion-measure-cqfm
 */

library HIVIND61Logic</a:s>
      </a:s>
   </annotation>
   <identifier id="HIVIND61Logic" system="http://smart.who.int/hiv"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
      <def localId="1" locator="52:1-52:26" localIdentifier="FHIR" uri="http://hl7.org/fhir" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="1">
               <a:s>// Included Libraries
using </a:s>
               <a:s>
                  <a:s>FHIR</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
   </usings>
   <includes>
      <def localId="2" locator="54:1-54:44" localIdentifier="HIC" path="http://smart.who.int/hiv/HIVCommon" version="0.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="2">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVCommon</a:s>
               </a:s>
               <a:s> version '0.0.1' called HIC</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="3" locator="55:1-55:35" localIdentifier="FHIRHelpers" path="http://hl7.org/fhir/FHIRHelpers" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="3">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRHelpers</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="4" locator="57:1-57:29" localIdentifier="WCom" path="http://smart.who.int/hiv/WHOCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="4">
               <a:s>include </a:s>
               <a:s>
                  <a:s>WHOCommon</a:s>
               </a:s>
               <a:s> called WCom</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="5" locator="58:1-58:29" localIdentifier="HE" path="http://smart.who.int/hiv/HIVElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="5">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVElements</a:s>
               </a:s>
               <a:s> called HE</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="6" locator="59:1-59:39" localIdentifier="HIE" path="http://smart.who.int/hiv/HIVIndicatorElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="6">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVIndicatorElements</a:s>
               </a:s>
               <a:s> called HIE</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="7" locator="60:1-60:31" localIdentifier="Config" path="http://smart.who.int/hiv/HIVConfig">
         <annotation xsi:type="a:Annotation">
            <a:s r="7">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVConfig</a:s>
               </a:s>
               <a:s> called Config</a:s>
            </a:s>
         </annotation>
      </def>
   </includes>
   <parameters>
      <def localId="13" locator="63:1-63:88" name="Measurement Period" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="13">
               <a:s>// Indicator Definition
parameter &quot;Measurement Period&quot; </a:s>
               <a:s r="12">
                  <a:s>Interval&lt;</a:s>
                  <a:s r="11">
                     <a:s>Date</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s> default </a:s>
               <a:s r="10">
                  <a:s r="8">Interval[@2023-01-01, @2023-01-30]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <default localId="10" locator="63:55-63:88" lowClosed="true" highClosed="true" xsi:type="Interval">
            <low localId="8" locator="63:64-63:74" xsi:type="Date">
               <year valueType="t:Integer" value="2023" xsi:type="Literal"/>
               <month valueType="t:Integer" value="1" xsi:type="Literal"/>
               <day valueType="t:Integer" value="1" xsi:type="Literal"/>
            </low>
            <high localId="9" locator="63:77-63:87" xsi:type="Date">
               <year valueType="t:Integer" value="2023" xsi:type="Literal"/>
               <month valueType="t:Integer" value="1" xsi:type="Literal"/>
               <day valueType="t:Integer" value="30" xsi:type="Literal"/>
            </high>
         </default>
         <parameterTypeSpecifier localId="12" locator="63:32-63:45" xsi:type="IntervalTypeSpecifier">
            <pointType localId="11" locator="63:41-63:44" name="t:Date" xsi:type="NamedTypeSpecifier"/>
         </parameterTypeSpecifier>
      </def>
   </parameters>
   <contexts>
      <def locator="65:1-65:15" name="Patient"/>
   </contexts>
   <statements>
      <def locator="65:1-65:15" name="Patient" context="Patient">
         <expression xsi:type="SingletonFrom">
            <operand locator="65:1-65:15" dataType="fhir:Patient" templateId="http://hl7.org/fhir/StructureDefinition/Patient" xsi:type="Retrieve"/>
         </expression>
      </def>
      <def localId="15" locator="72:1-73:6" name="Initial Population" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="15">
               <a:s r="14">/* Populations */

/*
 *Initial Population
 */

define &quot;Initial Population&quot;:
  true</a:s>
            </a:s>
         </annotation>
         <expression localId="14" locator="73:3-73:6" valueType="t:Boolean" value="true" xsi:type="Literal"/>
      </def>
      <def localId="36" locator="83:1-87:3" name="Numerator" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="36">
               <a:s>/**
 * Numerator
 * 
 * Definition: Number of pregnant women tested for syphilis while attending any ANC services
 * Calculation: COUNT of pregnant women with &quot;ANC contact date&quot; in reporting period AND &quot;Syphilis test date&quot; on ANY &quot;ANC contact date&quot; for this pregnancy
 */


define &quot;Numerator&quot;:
  </a:s>
               <a:s r="35">
                  <a:s r="18">
                     <a:s>exists</a:s>
                     <a:s r="17">
                        <a:s>(</a:s>
                        <a:s r="17">
                           <a:s r="16">
                              <a:s>HIE</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="17">
                              <a:s>&quot;ANC within pregnancy within measurement period&quot;</a:s>
                           </a:s>
                        </a:s>
                        <a:s>)</a:s>
                     </a:s>
                  </a:s>
                  <a:s>
  and </a:s>
                  <a:s r="34">
                     <a:s>exists</a:s>
                     <a:s r="33">
                        <a:s>(</a:s>
                        <a:s r="33">
                           <a:s>
                              <a:s r="20">
                                 <a:s r="19">
                                    <a:s>
                                       <a:s>HE.&quot;Syphilis test date B.DE249&quot;</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s> P</a:s>
                              </a:s>
                           </a:s>
                           <a:s>
    </a:s>
                           <a:s r="32">
                              <a:s>where </a:s>
                              <a:s r="32">
                                 <a:s>exists</a:s>
                                 <a:s r="31">
                                    <a:s>(</a:s>
                                    <a:s r="31">
                                       <a:s>
                                          <a:s r="22">
                                             <a:s r="21">
                                                <a:s>
                                                   <a:s>HIE.&quot;all anc dates&quot;</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s> t</a:s>
                                          </a:s>
                                       </a:s>
                                       <a:s> </a:s>
                                       <a:s r="30">
                                          <a:s>where </a:s>
                                          <a:s r="30">
                                             <a:s r="28">
                                                <a:s>duration in days of </a:s>
                                                <a:s r="27">
                                                   <a:s>(</a:s>
                                                   <a:s r="27">
                                                      <a:s r="23">
                                                         <a:s>t</a:s>
                                                      </a:s>
                                                      <a:s> intersect </a:s>
                                                      <a:s r="26">
                                                         <a:s r="25">
                                                            <a:s r="24">
                                                               <a:s>P</a:s>
                                                            </a:s>
                                                            <a:s>.</a:s>
                                                            <a:s r="25">
                                                               <a:s>performed</a:s>
                                                            </a:s>
                                                         </a:s>
                                                         <a:s>.</a:s>
                                                         <a:s r="26">
                                                            <a:s>toInterval()</a:s>
                                                         </a:s>
                                                      </a:s>
                                                   </a:s>
                                                   <a:s>)</a:s>
                                                </a:s>
                                             </a:s>
                                             <a:s r="29"> > 0</a:s>
                                          </a:s>
                                       </a:s>
                                    </a:s>
                                    <a:s>)</a:s>
                                 </a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
  )</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="35" locator="84:3-87:3" xsi:type="And">
            <operand localId="18" locator="84:3-84:62" xsi:type="Exists">
               <operand localId="17" locator="84:9-84:62" name="ANC within pregnancy within measurement period" libraryName="HIE" xsi:type="ExpressionRef"/>
            </operand>
            <operand localId="34" locator="85:7-87:3" xsi:type="Exists">
               <signature xsi:type="ListTypeSpecifier">
                  <elementType name="fhir:Procedure" xsi:type="NamedTypeSpecifier"/>
               </signature>
               <operand localId="33" locator="85:13-87:3" xsi:type="Query">
                  <source localId="20" locator="85:14-85:46" alias="P">
                     <expression localId="19" locator="85:14-85:44" name="Syphilis test date B.DE249" libraryName="HE" xsi:type="ExpressionRef"/>
                  </source>
                  <where localId="32" locator="86:5-86:108" xsi:type="Exists">
                     <signature xsi:type="ListTypeSpecifier">
                        <elementType xsi:type="IntervalTypeSpecifier">
                           <pointType name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                        </elementType>
                     </signature>
                     <operand localId="31" locator="86:17-86:108" xsi:type="Query">
                        <source localId="22" locator="86:18-86:38" alias="t">
                           <expression localId="21" locator="86:18-86:36" name="all anc dates" libraryName="HIE" xsi:type="ExpressionRef"/>
                        </source>
                        <where localId="30" locator="86:40-86:107" xsi:type="Greater">
                           <signature name="t:Integer" xsi:type="NamedTypeSpecifier"/>
                           <signature name="t:Integer" xsi:type="NamedTypeSpecifier"/>
                           <operand localId="28" locator="86:46-86:103" precision="Day" xsi:type="DurationBetween">
                              <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                              <signature name="t:DateTime" xsi:type="NamedTypeSpecifier"/>
                              <operand xsi:type="Start">
                                 <operand localId="27" locator="86:66-86:103" xsi:type="Intersect">
                                    <operand localId="23" locator="86:67" name="t" xsi:type="AliasRef"/>
                                    <operand localId="26" locator="86:79-86:102" name="toInterval" libraryName="WCom" xsi:type="FunctionRef">
                                       <operand localId="25" locator="86:79-86:89" path="performed" scope="P" xsi:type="Property"/>
                                    </operand>
                                 </operand>
                              </operand>
                              <operand xsi:type="End">
                                 <operand localId="27" locator="86:66-86:103" xsi:type="Intersect">
                                    <operand localId="23" locator="86:67" name="t" xsi:type="AliasRef"/>
                                    <operand localId="26" locator="86:79-86:102" name="toInterval" libraryName="WCom" xsi:type="FunctionRef">
                                       <operand localId="25" locator="86:79-86:89" path="performed" scope="P" xsi:type="Property"/>
                                    </operand>
                                 </operand>
                              </operand>
                           </operand>
                           <operand localId="29" locator="86:107" valueType="t:Integer" value="0" xsi:type="Literal"/>
                        </where>
                     </operand>
                  </where>
               </operand>
            </operand>
         </expression>
      </def>
      <def localId="40" locator="100:1-101:62" name="Denominator" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="40">
               <a:s>/**
 * Denominator
 *
 * Definition: Number of pregnant women attending ANC services
 * Calculation: COUNT of pregnant women with &quot;ANC contact date&quot; in reporting period
 */

define &quot;Denominator&quot;:
  </a:s>
               <a:s r="39">
                  <a:s>exists</a:s>
                  <a:s r="38">
                     <a:s>(</a:s>
                     <a:s r="38">
                        <a:s r="37">
                           <a:s>HIE</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="38">
                           <a:s>&quot;ANC within pregnancy within measurement period&quot;</a:s>
                        </a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="39" locator="101:3-101:62" xsi:type="Exists">
            <signature xsi:type="ListTypeSpecifier">
               <elementType name="fhir:Encounter" xsi:type="NamedTypeSpecifier"/>
            </signature>
            <operand localId="38" locator="101:9-101:62" name="ANC within pregnancy within measurement period" libraryName="HIE" xsi:type="ExpressionRef"/>
         </expression>
      </def>
      <def localId="43" locator="111:1-112:26" name="Age Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="43">
               <a:s>/* end Populations */

/*
 * Disaggregators
 */


define &quot;Age Stratifier&quot;:
	</a:s>
               <a:s r="42">
                  <a:s r="41">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="42">
                     <a:s>&quot;By Age Stratifier 9&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="42" locator="112:2-112:26" name="By Age Stratifier 9" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="46" locator="114:1-115:38" name="Geographic Region Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="46">
               <a:s>define &quot;Geographic Region Stratifier&quot;:
	</a:s>
               <a:s r="45">
                  <a:s r="44">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="45">
                     <a:s>&quot;By Geographic Region Stratifier&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="45" locator="115:2-115:38" name="By Geographic Region Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="49" locator="117:1-118:29" name="HIV Status" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="49">
               <a:s>define &quot;HIV Status&quot;:
  </a:s>
               <a:s r="48">
                  <a:s r="47">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="48">
                     <a:s>&quot;HIV Status Stratifier&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="48" locator="118:3-118:29" name="HIV Status Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="63" locator="120:1-123:40" name="Stratification" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="63">
               <a:s>define &quot;Stratification&quot;:
</a:s>
               <a:s r="62">
                  <a:s r="58">
                     <a:s r="56">
                        <a:s r="53">
                           <a:s r="51">
                              <a:s r="50">
                                 <a:s>HIE</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="51">
                                 <a:s>&quot;By Age Stratifier 9&quot;</a:s>
                              </a:s>
                           </a:s>
                           <a:s>
+ </a:s>
                           <a:s r="52">
                              <a:s>':'</a:s>
                           </a:s>
                        </a:s>
                        <a:s> + </a:s>
                        <a:s r="55">
                           <a:s r="54">
                              <a:s>HIE</a:s>
                           </a:s>
                           <a:s>.</a:s>
                           <a:s r="55">
                              <a:s>&quot;By Geographic Region Stratifier&quot;</a:s>
                           </a:s>
                        </a:s>
                     </a:s>
                     <a:s>
+ </a:s>
                     <a:s r="57">
                        <a:s>':'</a:s>
                     </a:s>
                  </a:s>
                  <a:s> + </a:s>
                  <a:s r="61">
                     <a:s r="60">
                        <a:s r="59">
                           <a:s>HIE</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="60">
                           <a:s>&quot;HIV Status Stratifier&quot;</a:s>
                        </a:s>
                     </a:s>
                     <a:s>.</a:s>
                     <a:s r="61">
                        <a:s>code</a:s>
                     </a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="62" locator="121:1-123:40" xsi:type="Concatenate">
            <operand localId="58" locator="121:1-123:5" xsi:type="Concatenate">
               <operand localId="56" locator="121:1-122:45" xsi:type="Concatenate">
                  <operand localId="53" locator="121:1-122:5" xsi:type="Concatenate">
                     <operand localId="51" locator="121:1-121:25" name="By Age Stratifier 9" libraryName="HIE" xsi:type="ExpressionRef"/>
                     <operand localId="52" locator="122:3-122:5" valueType="t:String" value=":" xsi:type="Literal"/>
                  </operand>
                  <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                     <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                     <operand localId="55" locator="122:9-122:45" name="By Geographic Region Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
                  </operand>
               </operand>
               <operand localId="57" locator="123:3-123:5" valueType="t:String" value=":" xsi:type="Literal"/>
            </operand>
            <operand localId="61" locator="123:9-123:40" path="code" xsi:type="Property">
               <source localId="60" locator="123:9-123:35" name="HIV Status Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
            </operand>
         </expression>
      </def>
   </statements>
</library>
