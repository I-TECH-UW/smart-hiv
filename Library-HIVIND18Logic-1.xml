<?xml version="1.0" encoding="UTF-8"?>
<library xmlns="urn:hl7-org:elm:r1" xmlns:t="urn:hl7-org:elm-types:r1" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:fhir="http://hl7.org/fhir" xmlns:qdm43="urn:healthit-gov:qdm:v4_3" xmlns:qdm53="urn:healthit-gov:qdm:v5_3" xmlns:a="urn:hl7-org:cql-annotations:r1">
   <annotation translatorOptions="EnableAnnotations,EnableLocators,DisableListDemotion,DisableListPromotion" signatureLevel="Overloads" xsi:type="a:CqlToElmInfo"/>
   <annotation xsi:type="a:Annotation">
      <a:s r="51">
         <a:s>/**
 * Library: HIV.IND.18 Logic
 * Ref No: HTS.1
 * Short Name: People living with HIV who know their HIV status (first 95)
 *
 * Definition: Number and % of people living with HIV who know their HIV status
 *
 * Numerator: Number of people living with HIV who have received their diagnosis and are still alive
 * Numerator Calculation: COUNT of clients with &quot;HIV status&quot;='HIV-positive' AND &quot;Date informed of HIV-positive diagnosis&quot; before reporting period end date
 * Numerator Exclusions: Exclude clients who are lost to follow up, transferred out, died, or refused (stopped) ART
 *
 * Denominator: Estimated number of people living with HIV
 * Denominator Calculation: *Estimated number of people living with HIV
 * Denominator Exclusions: 
 *
 * Disaggregations:
 * • Gender (female, male, other**) 
 *  • Age (0–4, 5–9, 10–14, 15–19, 20–24, 25–49, 50+ years)*** 
 *  • Key populations (men who have sex with men, people living in prisons and other closed 
 *  settings, people who inject drugs, sex workers, trans and gender diverse people)**** 
 *  • ANC attendees 
 *  • Cities and other administrative regions of epidemiologic importance
 *
 * Disaggregation Elements: Gender | Age | Key population member type | ANC contact date
 *
 * Numerator and Denominator Elements:
 * Date informed of HIV-positive diagnosis 
 *  HIV status
 *
 * Reference: Consolidated guidelines on person-centred HIV strategic information: strengthening routine data for impact. Geneva: World Health Organization; 2022
 * 
 * Data Concepts:
 * HIV.A.DE17: Age | Calculated age (number of years) of the client based on date of birth
 * HIV.A.DE18: Gender* | Gender of the client*
 * HIV.A.DE19: Female | Client identifies as female
 * HIV.A.DE20: Male | Client identifies as male
 * HIV.A.DE21: Transgender male | Client identifies as transgender male
 * HIV.A.DE22: Transgender female | Client identifies as transgender female
 * HIV.A.DE23: Other | Additional category
 * HIV.B.DE50: Key population member type* | The type of key population that the client is included in
 * HIV.B.DE51: Sex worker | Client is a sex worker
 * HIV.B.DE52: Men who have sex with men | Client is a man who has sex with men
 * HIV.B.DE53: Trans and gender-diverse people | Client identifies as trans and gender-diverse
 * HIV.B.DE54: People who inject drugs | Client is a person who injects drugs
 * HIV.B.DE55: People living in prisons and other closed settings | Client lives in a prison or another closed setting
 * HIV.B.DE65: Date informed of HIV-positive diagnosis | The date on which the client was diagnosed with HIV
 * HIV.B.DE115: HIV status | HIV status reported after applying the national HIV testing algorithm. No single HIV test can provide an HIV-positive diagnosis.
 * HIV.B.DE116: HIV-positive | Client is HIV-positive
 * HIV.B.DE117: HIV-negative | Client is HIV-negative
 * HIV.B.DE118: Unknown | Client has unknown HIV status
 * HIV.E.DE85: ANC contact date | The date and time of the client's ANC contact (in the ANC DAK this is called 'Contact date')
 * HIV.E.DE114: Key population member type* | The type of key population that the infant's mother is included in
 * HIV.E.DE115: Sex worker | Infant's mother is a sex worker
 * HIV.E.DE116: People who inject drugs | Infant's mother is a person who injects drugs
 * HIV.E.DE117: Trans and gender-diverse people | Infant's mother identifies as trans and gender-diverse
 * HIV.E.DE118: People living in prisons and other closed setting | Infant's mother is in a prison or closed setting
 * HIV.SRV.DE18: ANC contact date | The date and time of the client's ANC contact (in the ANC DAK this is called 'Contact date')
 *
 * Additional Context
 * - what it measures: This measures the number and percentage of people living with HIV who have been tested and know their HIV status.
 * - rationale: • Knowledge of HIV status is the entry point for people living with HIV to treatment and the continuum of care, and for those who test HIV-negative and remain at elevated risk of HIV acquisition, to prevention interventions. | • Disaggregated estimates can reveal gaps in access to testing among important groups of people living with HIV
 * - method: For the numerator: Best estimate based on available data sources |  | 1. Direct estimates from HIV case surveillance systems of the number of people living with HIV diagnosed with HIV, reported by a surveillance system and who are still alive. HIV case surveillance data can be used if reporting from all facilities providing confirmatory HIV testing and treatment services has been in place since at least 2014 and if people who have died, been lost to follow-up, etc., are removed from the numerator. Only confirmed HIV diagnoses should be counted. Mechanisms should be in place to de-duplicate individuals reported multiple times or from multiple facilities. |  | 2. Modelled estimates, for which the modelling approach depends on the availability of country data. For countries with robust case surveillance and vital registration systems, the number of people who know their HIV status can be derived using the Case Surveillance and Vital Registration (CSAVR) fitting tool in the Spectrum AIDS Impact Module (AIM). For countries with household population survey data that either directly capture the number of HIV-positive respondents who report that they know their status or the number of HIV- positive people who report ever having been tested, UNAIDS recommends (as of 2018) that the first 90 be modelled using the Shiny First 90.*
 * 
 * Suggested Scoring Method: proportion | http://hl7.org/fhir/us/cqfmeasures/StructureDefinition/proportion-measure-cqfm
 */

library HIVIND18Logic</a:s>
      </a:s>
   </annotation>
   <identifier id="HIVIND18Logic" system="http://smart.who.int/hiv"/>
   <schemaIdentifier id="urn:hl7-org:elm" version="r1"/>
   <usings>
      <def localIdentifier="System" uri="urn:hl7-org:elm-types:r1"/>
      <def localId="1" locator="70:1-70:26" localIdentifier="FHIR" uri="http://hl7.org/fhir" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="1">
               <a:s>// Included Libraries
using </a:s>
               <a:s>
                  <a:s>FHIR</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
   </usings>
   <includes>
      <def localId="2" locator="72:1-72:44" localIdentifier="HIC" path="http://smart.who.int/hiv/HIVCommon" version="0.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="2">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVCommon</a:s>
               </a:s>
               <a:s> version '0.0.1' called HIC</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="3" locator="73:1-73:35" localIdentifier="FHIRHelpers" path="http://hl7.org/fhir/FHIRHelpers" version="4.0.1">
         <annotation xsi:type="a:Annotation">
            <a:s r="3">
               <a:s>include </a:s>
               <a:s>
                  <a:s>FHIRHelpers</a:s>
               </a:s>
               <a:s> version '4.0.1'</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="4" locator="74:1-74:29" localIdentifier="WCom" path="http://smart.who.int/hiv/WHOCommon">
         <annotation xsi:type="a:Annotation">
            <a:s r="4">
               <a:s>include </a:s>
               <a:s>
                  <a:s>WHOCommon</a:s>
               </a:s>
               <a:s> called WCom</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="5" locator="76:1-76:29" localIdentifier="HE" path="http://smart.who.int/hiv/HIVElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="5">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVElements</a:s>
               </a:s>
               <a:s> called HE</a:s>
            </a:s>
         </annotation>
      </def>
      <def localId="6" locator="77:1-77:39" localIdentifier="HIE" path="http://smart.who.int/hiv/HIVIndicatorElements">
         <annotation xsi:type="a:Annotation">
            <a:s r="6">
               <a:s>include </a:s>
               <a:s>
                  <a:s>HIVIndicatorElements</a:s>
               </a:s>
               <a:s> called HIE</a:s>
            </a:s>
         </annotation>
      </def>
   </includes>
   <parameters>
      <def localId="12" locator="80:1-80:88" name="Measurement Period" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="12">
               <a:s>// Indicator Definition
parameter &quot;Measurement Period&quot; </a:s>
               <a:s r="11">
                  <a:s>Interval&lt;</a:s>
                  <a:s r="10">
                     <a:s>Date</a:s>
                  </a:s>
                  <a:s>></a:s>
               </a:s>
               <a:s> default </a:s>
               <a:s r="9">
                  <a:s r="7">Interval[@2023-01-01, @2023-01-30]</a:s>
               </a:s>
            </a:s>
         </annotation>
         <default localId="9" locator="80:55-80:88" lowClosed="true" highClosed="true" xsi:type="Interval">
            <low localId="7" locator="80:64-80:74" xsi:type="Date">
               <year valueType="t:Integer" value="2023" xsi:type="Literal"/>
               <month valueType="t:Integer" value="1" xsi:type="Literal"/>
               <day valueType="t:Integer" value="1" xsi:type="Literal"/>
            </low>
            <high localId="8" locator="80:77-80:87" xsi:type="Date">
               <year valueType="t:Integer" value="2023" xsi:type="Literal"/>
               <month valueType="t:Integer" value="1" xsi:type="Literal"/>
               <day valueType="t:Integer" value="30" xsi:type="Literal"/>
            </high>
         </default>
         <parameterTypeSpecifier localId="11" locator="80:32-80:45" xsi:type="IntervalTypeSpecifier">
            <pointType localId="10" locator="80:41-80:44" name="t:Date" xsi:type="NamedTypeSpecifier"/>
         </parameterTypeSpecifier>
      </def>
   </parameters>
   <contexts>
      <def locator="82:1-82:15" name="Patient"/>
   </contexts>
   <statements>
      <def locator="82:1-82:15" name="Patient" context="Patient">
         <expression xsi:type="SingletonFrom">
            <operand locator="82:1-82:15" dataType="fhir:Patient" templateId="http://hl7.org/fhir/StructureDefinition/Patient" xsi:type="Retrieve"/>
         </expression>
      </def>
      <def localId="15" locator="83:1-84:32" name="Measure Population" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="15">
               <a:s>define &quot;Measure Population&quot;:
   </a:s>
               <a:s r="14">
                  <a:s r="13">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="14">
                     <a:s>&quot;Has HIV-positive Status&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="14" locator="84:4-84:32" name="Has HIV-positive Status" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="17" locator="89:1-90:6" name="Initial Population" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="17">
               <a:s r="16">/*
 * As defined by Member States
 */
define &quot;Initial Population&quot;:
  true</a:s>
            </a:s>
         </annotation>
         <expression localId="16" locator="90:3-90:6" valueType="t:Boolean" value="true" xsi:type="Literal"/>
      </def>
      <def localId="20" locator="96:1-97:3" name="Measure Observation" context="Patient" accessLevel="Public" xsi:type="FunctionDef">
         <annotation xsi:type="a:Annotation">
            <a:s r="20">
               <a:s>/*
 * NOTE: Modeled as a Continuous Variable measure because this is an estimated denominator proportion measure
 */

define function &quot;Measure Observation&quot;(Patient &quot;Patient&quot;):
  </a:s>
               <a:s r="19">
                  <a:s r="19">1</a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="19" locator="97:3" valueType="t:Integer" value="1" xsi:type="Literal"/>
         <operand name="Patient">
            <operandTypeSpecifier localId="18" locator="96:47-96:55" name="fhir:Patient" xsi:type="NamedTypeSpecifier"/>
         </operand>
      </def>
      <def localId="23" locator="103:1-104:42" name="Administrative Gender Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="23">
               <a:s>/*
 * Disaggregators
 */

define &quot;Administrative Gender Stratifier&quot;:
	</a:s>
               <a:s r="22">
                  <a:s r="21">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="22">
                     <a:s>&quot;By Administrative Gender Stratifier&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="22" locator="104:2-104:42" name="By Administrative Gender Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="26" locator="106:1-107:26" name="Age Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="26">
               <a:s>define &quot;Age Stratifier&quot;:
	</a:s>
               <a:s r="25">
                  <a:s r="24">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="25">
                     <a:s>&quot;By Age Stratifier 2&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="25" locator="107:2-107:26" name="By Age Stratifier 2" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="29" locator="109:1-110:38" name="Geographic Region Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="29">
               <a:s>define &quot;Geographic Region Stratifier&quot;:
	</a:s>
               <a:s r="28">
                  <a:s r="27">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="28">
                     <a:s>&quot;By Geographic Region Stratifier&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="28" locator="110:2-110:38" name="By Geographic Region Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="32" locator="112:1-113:20" name="patientGroups Stratifier" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="32">
               <a:s>define &quot;patientGroups Stratifier&quot;:
	</a:s>
               <a:s r="31">
                  <a:s r="30">
                     <a:s>HIE</a:s>
                  </a:s>
                  <a:s>.</a:s>
                  <a:s r="31">
                     <a:s>&quot;patientGroups&quot;</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="31" locator="113:2-113:20" name="patientGroups" libraryName="HIE" xsi:type="ExpressionRef"/>
      </def>
      <def localId="51" locator="119:1-123:33" name="Stratification" context="Patient" accessLevel="Public">
         <annotation xsi:type="a:Annotation">
            <a:s r="51">
               <a:s>// define &quot;ANC Stratifier&quot;:
//     HIC.&quot;anc&quot;


define &quot;Stratification&quot;:
 </a:s>
               <a:s r="50">
                  <a:s r="45">
                     <a:s r="42">
                        <a:s r="40">
                           <a:s r="37">
                              <a:s r="35">
                                 <a:s r="34">
                                    <a:s r="33">
                                       <a:s>HIE</a:s>
                                    </a:s>
                                    <a:s>.</a:s>
                                    <a:s r="34">
                                       <a:s>&quot;By Administrative Gender Stratifier&quot;</a:s>
                                    </a:s>
                                 </a:s>
                                 <a:s>.</a:s>
                                 <a:s r="35">
                                    <a:s>code</a:s>
                                 </a:s>
                              </a:s>
                              <a:s> 
  + </a:s>
                              <a:s r="36">
                                 <a:s>':'</a:s>
                              </a:s>
                           </a:s>
                           <a:s> + </a:s>
                           <a:s r="39">
                              <a:s r="38">
                                 <a:s>HIE</a:s>
                              </a:s>
                              <a:s>.</a:s>
                              <a:s r="39">
                                 <a:s>&quot;By Age Stratifier 2&quot;</a:s>
                              </a:s>
                           </a:s>
                        </a:s>
                        <a:s>
+ </a:s>
                        <a:s r="41">
                           <a:s>':'</a:s>
                        </a:s>
                     </a:s>
                     <a:s> + </a:s>
                     <a:s r="44">
                        <a:s r="43">
                           <a:s>HIE</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="44">
                           <a:s>&quot;By Geographic Region Stratifier&quot;</a:s>
                        </a:s>
                     </a:s>
                  </a:s>
                  <a:s>
+ </a:s>
                  <a:s r="49">
                     <a:s>Combine(</a:s>
                     <a:s r="47">
                        <a:s r="46">
                           <a:s>HIE</a:s>
                        </a:s>
                        <a:s>.</a:s>
                        <a:s r="47">
                           <a:s>patientGroups</a:s>
                        </a:s>
                     </a:s>
                     <a:s>, </a:s>
                     <a:s r="48">
                        <a:s>':'</a:s>
                     </a:s>
                     <a:s>)</a:s>
                  </a:s>
               </a:s>
            </a:s>
         </annotation>
         <expression localId="50" locator="120:2-123:33" xsi:type="Concatenate">
            <operand localId="45" locator="120:2-122:45" xsi:type="Concatenate">
               <operand localId="42" locator="120:2-122:5" xsi:type="Concatenate">
                  <operand localId="40" locator="120:2-121:35" xsi:type="Concatenate">
                     <operand localId="37" locator="120:2-121:7" xsi:type="Concatenate">
                        <operand localId="35" locator="120:2-120:47" path="code" xsi:type="Property">
                           <source localId="34" locator="120:2-120:42" name="By Administrative Gender Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
                        </operand>
                        <operand localId="36" locator="121:5-121:7" valueType="t:String" value=":" xsi:type="Literal"/>
                     </operand>
                     <operand localId="39" locator="121:11-121:35" name="By Age Stratifier 2" libraryName="HIE" xsi:type="ExpressionRef"/>
                  </operand>
                  <operand localId="41" locator="122:3-122:5" valueType="t:String" value=":" xsi:type="Literal"/>
               </operand>
               <operand name="ToString" libraryName="FHIRHelpers" xsi:type="FunctionRef">
                  <signature name="fhir:string" xsi:type="NamedTypeSpecifier"/>
                  <operand localId="44" locator="122:9-122:45" name="By Geographic Region Stratifier" libraryName="HIE" xsi:type="ExpressionRef"/>
               </operand>
            </operand>
            <operand localId="49" locator="123:3-123:33" xsi:type="Combine">
               <source localId="47" locator="123:11-123:27" name="patientGroups" libraryName="HIE" xsi:type="ExpressionRef"/>
               <separator localId="48" locator="123:30-123:32" valueType="t:String" value=":" xsi:type="Literal"/>
            </operand>
         </expression>
      </def>
   </statements>
</library>
